generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String    @map("password_hash")
  role         Role      @default(WRITER)
  avatarUrl    String?   @map("avatar_url")
  bio          String?
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")
  articles     Article[] @relation("AuthoredArticles")
  comments     Comment[]
  reviews      Review[]

  @@index([role, isActive])
  @@map("users")
}

model Article {
  id                  String           @id @default(cuid())
  headline            String
  subHeadline         String?          @map("sub_headline")
  body                String
  bodyHtml            String?          @map("body_html")
  slug                String?
  featuredImage       String?          @map("featured_image")
  featuredImageId     String?          @map("featured_image_id")
  imageCredit         String?          @map("image_credit")
  status              ArticleStatus    @default(DRAFT)
  authorId            String           @map("author_id")
  publishedUrl        String?          @map("published_url")
  publishedSite       String?          @map("published_site")
  publishedAt         DateTime?        @map("published_at")
  scheduledPublishAt        DateTime?  @map("scheduled_publish_at")
  scheduledPublishTargetId String?    @map("scheduled_publish_target_id")
  totalPageviews      Int              @default(0) @map("total_pageviews")
  totalUniqueVisitors Int              @default(0) @map("total_unique_visitors")
  analyticsUpdatedAt  DateTime?        @map("analytics_updated_at")
  submittedAt         DateTime?        @map("submitted_at")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  aiReviewFindings    Json?            @map("ai_review_findings")
  aiReviewStatus      String?          @map("ai_review_status")
  aiReviewedAt        DateTime?        @map("ai_reviewed_at")
  tags                ArticleTag[]
  versions            ArticleVersion[]
  author              User             @relation("AuthoredArticles", fields: [authorId], references: [id])
  comments            Comment[]
  reviews             Review[]
  socialPosts         SocialPost[]

  @@index([authorId])
  @@index([status])
  @@index([createdAt])
  @@index([status, publishedUrl])
  @@index([updatedAt])
  @@index([status, publishedAt])
  @@index([authorId, status])
  @@index([publishedAt])
  @@index([status, scheduledPublishAt])
  @@map("articles")
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  slug      String       @unique
  createdAt DateTime     @default(now()) @map("created_at")
  articles  ArticleTag[]

  @@map("tags")
}

model ArticleTag {
  articleId String  @map("article_id")
  tagId     String  @map("tag_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@index([tagId])
  @@map("article_tags")
}

model Review {
  id         String   @id @default(cuid())
  articleId  String   @map("article_id")
  reviewerId String   @map("reviewer_id")
  notes      String?
  decision   String
  createdAt  DateTime @default(now()) @map("created_at")
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  reviewer   User     @relation(fields: [reviewerId], references: [id])

  @@index([articleId])
  @@index([reviewerId])
  @@map("reviews")
}

model Comment {
  id        String   @id @default(cuid())
  articleId String   @map("article_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([articleId])
  @@index([userId])
  @@map("comments")
}

model ArticleVersion {
  id          String   @id @default(cuid())
  articleId   String   @map("article_id")
  version     Int
  headline    String
  subHeadline String?  @map("sub_headline")
  body        String
  bodyHtml    String?  @map("body_html")
  createdById String   @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  changeNote  String?  @map("change_note")
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([createdAt])
  @@map("article_versions")
}

model PublishTarget {
  id              String   @id @default(cuid())
  name            String   @unique
  type            String
  url             String
  apiKey          String?  @map("api_key")
  username        String?
  password        String?
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  clientId        String?  @map("client_id")
  clientSecret    String?  @map("client_secret")
  myshopifyDomain String?  @map("myshopify_domain")
  blogId          String?  @map("blog_id")
  socialAccounts  SocialAccount[]
  voiceProfile    SiteVoiceProfile?

  @@map("publish_targets")
}

enum Role {
  WRITER
  EDITOR
  ADMIN
}

enum ArticleStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  REVISION_REQUESTED
  APPROVED
  PUBLISHED
  REJECTED
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([email])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model SocialAccount {
  id                    String          @id @default(cuid())
  platform              SocialPlatform
  accountName           String          @map("account_name")
  accountHandle         String          @map("account_handle")
  accessToken           String          @map("access_token")
  refreshToken          String?         @map("refresh_token")
  tokenExpiresAt        DateTime?       @map("token_expires_at")
  publishTargetId       String?         @map("publish_target_id")
  isActive              Boolean         @default(true) @map("is_active")
  optimalHours          Json?           @map("optimal_hours")
  optimalHoursUpdatedAt DateTime?       @map("optimal_hours_updated_at")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  publishTarget         PublishTarget?  @relation(fields: [publishTargetId], references: [id])
  socialPosts           SocialPost[]

  @@index([platform])
  @@index([publishTargetId])
  @@index([isActive])
  @@unique([platform, accountHandle], name: "platform_accountHandle")
  @@map("social_accounts")
}

model SocialPost {
  id              String           @id @default(cuid())
  articleId       String           @map("article_id")
  socialAccountId String           @map("social_account_id")
  caption         String
  imageUrl        String?          @map("image_url")
  articleUrl      String           @map("article_url")
  scheduledAt     DateTime         @map("scheduled_at")
  sentAt          DateTime?        @map("sent_at")
  platformPostId  String?          @map("platform_post_id")
  status          SocialPostStatus @default(PENDING)
  errorMessage    String?          @map("error_message")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  article         Article          @relation(fields: [articleId], references: [id], onDelete: Cascade)
  socialAccount   SocialAccount    @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)

  @@index([status, scheduledAt])
  @@index([articleId])
  @@index([socialAccountId])
  @@index([scheduledAt])
  @@map("social_posts")
}

model SiteVoiceProfile {
  id               String        @id @default(cuid())
  publishTargetId  String        @unique @map("publish_target_id")
  voiceDescription String        @map("voice_description")
  systemPrompt     String        @map("system_prompt")
  sampleArticleIds Json          @map("sample_article_ids")
  customNotes      String?       @map("custom_notes")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  publishTarget    PublishTarget @relation(fields: [publishTargetId], references: [id])

  @@map("site_voice_profiles")
}

enum SocialPlatform {
  X
  FACEBOOK
  TRUTHSOCIAL
  INSTAGRAM
}

enum SocialPostStatus {
  PENDING
  APPROVED
  SENDING
  SENT
  FAILED
}
